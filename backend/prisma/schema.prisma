// Restaurant Accounting System - Prisma Schema
// PostgreSQL Database Schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  ACCOUNTANT

  @@map("user_role")
}

enum TransactionType {
  INCOME
  EXPENSE

  @@map("transaction_type")
}

enum PaymentMethod {
  CASH
  MASTER

  @@map("payment_method")
}

// Currency enum removed - currency is now ONLY in CurrencySettings table
// Database stores amounts without currency, frontend displays currency symbol

enum DebtStatus {
  ACTIVE
  PAID
  PARTIAL

  @@map("debt_status")
}

enum InventoryUnit {
  KG
  PIECE
  LITER
  OTHER

  @@map("inventory_unit")
}

enum InventoryOperationType {
  PURCHASE
  CONSUMPTION

  @@map("inventory_operation_type")
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL

  @@map("notification_severity")
}

enum DisplayMethod {
  POPUP
  TOAST
  EMAIL
  SMS

  @@map("display_method")
}

enum EmployeeStatus {
  ACTIVE
  RESIGNED

  @@map("employee_status")
}

enum EmployeeAdjustmentType {
  BONUS
  DEDUCTION
  ADVANCE

  @@map("employee_adjustment_type")
}

enum EmployeeAdjustmentStatus {
  PENDING
  PROCESSED
  CANCELLED

  @@map("employee_adjustment_status")
}

enum AdvanceStatus {
  ACTIVE
  PAID
  CANCELLED

  @@map("advance_status")
}

enum ReportType {
  FINANCIAL
  DEBTS
  INVENTORY
  SALARY
  BRANCHES
  CUSTOM

  @@map("report_type")
}

enum ContactType {
  SUPPLIER
  CUSTOMER
  BOTH
  OTHER

  @@map("contact_type")
}

enum DiscountType {
  PERCENTAGE
  AMOUNT

  @@map("discount_type")
}

// ============================================================================
// MODELS
// ============================================================================

// 1. Users Table
model User {
  id                  String    @id @default(uuid()) @db.Uuid
  username            String    @unique @db.VarChar(100)
  passwordHash        String    @map("password_hash") @db.VarChar(255)
  role                UserRole  @default(ACCOUNTANT)
  branchId            String?   @map("branch_id") @db.Uuid
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until") @db.Timestamptz
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt           DateTime? @map("deleted_at") @db.Timestamptz
  deletedBy           String?   @map("deleted_by") @db.Uuid
  isDeleted           Boolean   @default(false) @map("is_deleted")

  // Relations
  branch                           Branch?                    @relation(fields: [branchId], references: [id], onDelete: SetNull)
  deleter                          User?                      @relation("UserDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)
  deletedUsers                     User[]                     @relation("UserDeleter")
  refreshTokens                    RefreshToken[]
  recordedConsumptions             InventoryConsumption[]
  auditLogs                        AuditLog[]
  createdEmployees                 Employee[]                 @relation("EmployeeCreator")
  recordedSalaryPayments           SalaryPayment[]            @relation("SalaryPaymentRecorder")
  createdReportTemplates           ReportTemplate[]           @relation("ReportTemplateCreator")
  reportExecutions                 ReportExecution[]          @relation("ReportExecutor")
  contactsCreated                  Contact[]                  @relation("ContactCreator")
  contactsDeleted                  Contact[]                  @relation("ContactDeleter")
  branchesDeleted                  Branch[]                   @relation("BranchDeleter")
  payablesCreated                  AccountPayable[]           @relation("PayableCreator")
  payablesDeleted                  AccountPayable[]           @relation("PayableDeleter")
  receivablesCreated               AccountReceivable[]        @relation("ReceivableCreator")
  receivablesDeleted               AccountReceivable[]        @relation("ReceivableDeleter")
  payablePaymentsRecorded          PayablePayment[]           @relation("PayablePaymentRecorder")
  payablePaymentsDeleted           PayablePayment[]           @relation("PayablePaymentDeleter")
  receivablePaymentsRecorded       ReceivablePayment[]        @relation("ReceivablePaymentRecorder")
  receivablePaymentsDeleted        ReceivablePayment[]        @relation("ReceivablePaymentDeleter")
  consumptionsDeleted              InventoryConsumption[]     @relation("ConsumptionDeleter")
  notificationsCreated             Notification[]             @relation("NotificationCreator")
  notificationsDeleted             Notification[]             @relation("NotificationDeleter")
  transactionsCreated              Transaction[]              @relation("TransactionCreator")
  notificationSettings             NotificationSetting[]
  notificationSettingsDeleted      NotificationSetting[]      @relation("NotificationSettingDeleter")
  refreshTokensDeleted             RefreshToken[]             @relation("RefreshTokenDeleter")
  salaryPaymentsDeleted            SalaryPayment[]            @relation("SalaryPaymentDeleter")
  employeesDeleted                 Employee[]                 @relation("EmployeeDeleter")
  appSettingsDeleted               AppSettings[]              @relation("AppSettingsDeleter")
  currencySettingsDeleted          CurrencySettings[]         @relation("CurrencySettingsDeleter")
  reportTemplatesDeleted           ReportTemplate[]           @relation("ReportTemplateDeleter")
  reportFieldMetadataDeleted       ReportFieldMetadata[]      @relation("ReportFieldMetadataDeleter")
  transactionInventoryItemsDeleted TransactionInventoryItem[] @relation("TransactionInventoryItemDeleter")
  createdEmployeeAdjustments       EmployeeAdjustment[]       @relation("EmployeeAdjustmentCreator")
  deletedEmployeeAdjustments       EmployeeAdjustment[]       @relation("EmployeeAdjustmentDeleter")
  discountReasonsDeleted           DiscountReason[]           @relation("DiscountReasonDeleter")

  @@index([branchId])
  @@index([role])
  @@index([deletedBy])
  @@index([isDeleted])
  @@index([deletedAt])
  @@index([username])
  @@index([lockedUntil])
  @@map("users")
}

// 2. Refresh Tokens Table
model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  token     String    @unique @db.VarChar(500)
  userId    String    @map("user_id") @db.Uuid
  expiresAt DateTime  @map("expires_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  deletedBy String?   @map("deleted_by") @db.Uuid
  isDeleted Boolean   @default(false) @map("is_deleted")

  // Relations
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  deleter User? @relation("RefreshTokenDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("refresh_tokens")
}

// 3. Branches Table
model Branch {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar(200)
  location    String    @db.VarChar(500)
  managerName String    @map("manager_name") @db.VarChar(200)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz
  deletedBy   String?   @map("deleted_by") @db.Uuid
  isDeleted   Boolean   @default(false) @map("is_deleted")

  // Relations
  users                 User[]
  transactions          Transaction[]
  inventoryItems        InventoryItem[]
  inventoryConsumptions InventoryConsumption[]
  employees             Employee[]
  contacts              Contact[]
  accountsPayable       AccountPayable[]
  accountsReceivable    AccountReceivable[]
  notifications         Notification[]
  deleter               User?                  @relation("BranchDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([deletedBy])
  @@index([isDeleted])
  @@index([deletedAt])
  @@index([name])
  @@map("branches")
}

// 4. Transactions Table
model Transaction {
  id                 String          @id @default(uuid()) @db.Uuid
  branchId           String?         @map("branch_id") @db.Uuid
  type               TransactionType
  amount             Decimal         @db.Decimal(15, 2)
  paymentMethod      PaymentMethod?  @map("payment_method")
  category           String          @db.VarChar(100)
  date               DateTime        @db.Date
  employeeVendorName String          @map("employee_vendor_name") @db.VarChar(200)
  notes              String?         @db.Text
  inventoryItemId    String?         @map("inventory_item_id") @db.Uuid
  paidAmount         Decimal?        @map("paid_amount") @db.Decimal(15, 2)
  totalAmount        Decimal?        @map("total_amount") @db.Decimal(15, 2)
  // Discount fields
  discountType       DiscountType?   @map("discount_type")
  discountValue      Decimal?        @map("discount_value") @db.Decimal(15, 4)
  discountReason     String?         @map("discount_reason") @db.VarChar(200)
  subtotal           Decimal?        @map("subtotal") @db.Decimal(15, 2)
  contactId          String?         @map("contact_id") @db.Uuid
  linkedPayableId    String?         @map("linked_payable_id") @db.Uuid
  // NEW: Link to employee for salary, bonus, advance transactions
  employeeId         String?         @map("employee_id") @db.Uuid
  linkedReceivableId String?         @map("linked_receivable_id") @db.Uuid
  createdBy          String          @map("created_by") @db.Uuid
  createdAt          DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime        @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt          DateTime?       @map("deleted_at") @db.Timestamptz
  deletedBy          String?         @map("deleted_by") @db.Uuid
  isDeleted          Boolean         @default(false) @map("is_deleted")

  // Relations
  branch                    Branch?                    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator                   User                       @relation("TransactionCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  inventoryItem             InventoryItem?             @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  contact                   Contact?                   @relation("ContactTransactions", fields: [contactId], references: [id], onDelete: SetNull)
  employee                  Employee?                  @relation("EmployeeTransactions", fields: [employeeId], references: [id], onDelete: SetNull)
  linkedPayable             AccountPayable?            @relation("PurchasePayable")
  linkedReceivable          AccountReceivable?         @relation("SaleReceivable")
  salaryPayment             SalaryPayment?
  transactionInventoryItems TransactionInventoryItem[]
  payablePayment            PayablePayment?            @relation("PayablePaymentTransaction")
  receivablePayment         ReceivablePayment?         @relation("ReceivablePaymentTransaction")

  @@index([branchId])
  @@index([type])
  @@index([date])
  @@index([category])
  @@index([createdBy])
  @@index([paymentMethod])
  @@index([inventoryItemId])
  @@index([contactId])
  @@index([linkedPayableId])
  @@index([employeeId])
  @@index([linkedReceivableId])
  @@index([deletedAt])
  @@index([isDeleted])
  @@index([discountType])
  @@index([discountReason])
  @@index([branchId, date])
  @@index([type, date])
  @@map("transactions")
}

// NEW: Contact Model
model Contact {
  id          String      @id @default(uuid()) @db.Uuid
  name        String      @db.VarChar(200)
  type        ContactType
  phone       String?     @db.VarChar(20)
  email       String?     @db.VarChar(100)
  address     String?     @db.Text
  creditLimit Decimal?    @db.Decimal(15, 2)
  notes       String?     @db.Text
  branchId    String?     @map("branch_id") @db.Uuid
  createdBy   String      @map("created_by") @db.Uuid
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime    @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime?   @map("deleted_at") @db.Timestamptz
  deletedBy   String?     @map("deleted_by") @db.Uuid
  isDeleted   Boolean     @default(false) @map("is_deleted")

  // Relations
  branch             Branch?             @relation(fields: [branchId], references: [id], onDelete: SetNull)
  creator            User                @relation("ContactCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  deleter            User?               @relation("ContactDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)
  accountsPayable    AccountPayable[]
  accountsReceivable AccountReceivable[]
  transactions       Transaction[]       @relation("ContactTransactions")

  @@index([name])
  @@index([type])
  @@index([branchId])
  @@index([isDeleted])
  @@index([deletedAt])
  @@index([createdBy])
  @@map("contacts")
}

// NEW: Account Payable Model (Debts We Owe)
model AccountPayable {
  id                          String     @id @default(uuid()) @db.Uuid
  contactId                   String     @map("contact_id") @db.Uuid
  originalAmount              Decimal    @map("original_amount") @db.Decimal(15, 2)
  remainingAmount             Decimal    @map("remaining_amount") @db.Decimal(15, 2)
  date                        DateTime   @db.Date
  dueDate                     DateTime?  @map("due_date") @db.Date
  status                      DebtStatus @default(ACTIVE)
  description                 String?    @db.Text
  invoiceNumber               String?    @map("invoice_number") @db.VarChar(50)
  notes                       String?    @db.Text
  linkedPurchaseTransactionId String?    @unique @map("linked_purchase_transaction_id") @db.Uuid
  branchId                    String?    @map("branch_id") @db.Uuid
  createdBy                   String     @map("created_by") @db.Uuid
  createdAt                   DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                   DateTime   @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt                   DateTime?  @map("deleted_at") @db.Timestamptz
  deletedBy                   String?    @map("deleted_by") @db.Uuid
  isDeleted                   Boolean    @default(false) @map("is_deleted")

  // Relations
  contact             Contact          @relation(fields: [contactId], references: [id], onDelete: Restrict)
  branch              Branch?          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator             User             @relation("PayableCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  deleter             User?            @relation("PayableDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)
  purchaseTransaction Transaction?     @relation("PurchasePayable", fields: [linkedPurchaseTransactionId], references: [id], onDelete: SetNull)
  payments            PayablePayment[]

  @@index([contactId])
  @@index([status])
  @@index([dueDate])
  @@index([branchId])
  @@index([isDeleted])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([date])
  @@map("accounts_payable")
}

// NEW: Account Receivable Model (Debts Owed to Us)
model AccountReceivable {
  id                      String     @id @default(uuid()) @db.Uuid
  contactId               String     @map("contact_id") @db.Uuid
  originalAmount          Decimal    @map("original_amount") @db.Decimal(15, 2)
  remainingAmount         Decimal    @map("remaining_amount") @db.Decimal(15, 2)
  date                    DateTime   @db.Date
  dueDate                 DateTime?  @map("due_date") @db.Date
  status                  DebtStatus @default(ACTIVE)
  description             String?    @db.Text
  invoiceNumber           String?    @map("invoice_number") @db.VarChar(50)
  notes                   String?    @db.Text
  linkedSaleTransactionId String?    @unique @map("linked_sale_transaction_id") @db.Uuid
  branchId                String?    @map("branch_id") @db.Uuid
  createdBy               String     @map("created_by") @db.Uuid
  createdAt               DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime   @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt               DateTime?  @map("deleted_at") @db.Timestamptz
  deletedBy               String?    @map("deleted_by") @db.Uuid
  isDeleted               Boolean    @default(false) @map("is_deleted")

  // Relations
  contact         Contact             @relation(fields: [contactId], references: [id], onDelete: Restrict)
  branch          Branch?             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator         User                @relation("ReceivableCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  deleter         User?               @relation("ReceivableDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)
  saleTransaction Transaction?        @relation("SaleReceivable", fields: [linkedSaleTransactionId], references: [id], onDelete: SetNull)
  payments        ReceivablePayment[]

  @@index([contactId])
  @@index([status])
  @@index([dueDate])
  @@index([branchId])
  @@index([isDeleted])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([date])
  @@map("accounts_receivable")
}

// NEW: Payable Payment Model
model PayablePayment {
  id            String         @id @default(uuid()) @db.Uuid
  payableId     String         @map("payable_id") @db.Uuid
  amountPaid    Decimal        @map("amount_paid") @db.Decimal(15, 2)
  paymentDate   DateTime       @map("payment_date") @db.Date
  paymentMethod PaymentMethod? @map("payment_method")
  notes         String?        @db.Text
  transactionId String?        @unique @map("transaction_id") @db.Uuid
  recordedBy    String         @map("recorded_by") @db.Uuid
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime?      @map("deleted_at") @db.Timestamptz
  deletedBy     String?        @map("deleted_by") @db.Uuid
  isDeleted     Boolean        @default(false) @map("is_deleted")

  // Relations
  payable     AccountPayable @relation(fields: [payableId], references: [id], onDelete: Cascade)
  transaction Transaction?   @relation("PayablePaymentTransaction", fields: [transactionId], references: [id], onDelete: SetNull)
  recorder    User           @relation("PayablePaymentRecorder", fields: [recordedBy], references: [id], onDelete: Restrict)
  deleter     User?          @relation("PayablePaymentDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([payableId])
  @@index([paymentDate])
  @@index([isDeleted])
  @@index([deletedAt])
  @@index([recordedBy])
  @@map("payable_payments")
}

// NEW: Receivable Payment Model
model ReceivablePayment {
  id            String         @id @default(uuid()) @db.Uuid
  receivableId  String         @map("receivable_id") @db.Uuid
  amountPaid    Decimal        @map("amount_paid") @db.Decimal(15, 2)
  paymentDate   DateTime       @map("payment_date") @db.Date
  paymentMethod PaymentMethod? @map("payment_method")
  notes         String?        @db.Text
  transactionId String?        @unique @map("transaction_id") @db.Uuid
  recordedBy    String         @map("recorded_by") @db.Uuid
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime?      @map("deleted_at") @db.Timestamptz
  deletedBy     String?        @map("deleted_by") @db.Uuid
  isDeleted     Boolean        @default(false) @map("is_deleted")

  // Relations
  receivable  AccountReceivable @relation(fields: [receivableId], references: [id], onDelete: Cascade)
  transaction Transaction?      @relation("ReceivablePaymentTransaction", fields: [transactionId], references: [id], onDelete: SetNull)
  recorder    User              @relation("ReceivablePaymentRecorder", fields: [recordedBy], references: [id], onDelete: Restrict)
  deleter     User?             @relation("ReceivablePaymentDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([receivableId])
  @@index([paymentDate])
  @@index([isDeleted])
  @@index([deletedAt])
  @@index([recordedBy])
  @@map("receivable_payments")
}

// NEW: Discount Reasons Table
model DiscountReason {
  id          String    @id @default(uuid()) @db.Uuid
  reason      String    @unique @db.VarChar(200)
  description String?   @db.Text
  isDefault   Boolean   @default(false) @map("is_default")
  sortOrder   Int       @default(999) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz
  deletedBy   String?   @map("deleted_by") @db.Uuid
  isDeleted   Boolean   @default(false) @map("is_deleted")

  // Relations
  deleter User? @relation("DiscountReasonDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([reason])
  @@index([isDefault])
  @@index([sortOrder])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("discount_reasons")
}

// 7. Inventory Items Table
model InventoryItem {
  id               String        @id @default(uuid()) @db.Uuid
  branchId         String        @map("branch_id") @db.Uuid
  name             String        @db.VarChar(200)
  quantity         Decimal       @db.Decimal(12, 3)
  unit             InventoryUnit
  costPerUnit      Decimal       @map("cost_per_unit") @db.Decimal(15, 2)
  sellingPrice     Decimal?      @map("selling_price") @db.Decimal(15, 2)
  includeInRevenue Boolean       @default(true) @map("include_in_revenue")
  lastUpdated      DateTime      @map("last_updated") @db.Timestamptz
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt        DateTime?     @map("deleted_at") @db.Timestamptz
  deletedBy        String?       @map("deleted_by") @db.Uuid
  isDeleted        Boolean       @default(false) @map("is_deleted")

  // Relations
  branch                    Branch                     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  transactions              Transaction[]
  consumptions              InventoryConsumption[]
  transactionInventoryItems TransactionInventoryItem[]

  @@index([branchId])
  @@index([name])
  @@index([unit])
  @@index([lastUpdated])
  @@index([deletedAt])
  @@index([isDeleted])
  @@map("inventory_items")
}

// 7b. Inventory Consumption Table
model InventoryConsumption {
  id              String        @id @default(uuid()) @db.Uuid
  inventoryItemId String        @map("inventory_item_id") @db.Uuid
  branchId        String        @map("branch_id") @db.Uuid
  quantity        Decimal       @db.Decimal(12, 3)
  unit            InventoryUnit
  reason          String?       @db.VarChar(500)
  consumedAt      DateTime      @map("consumed_at") @db.Timestamptz
  recordedBy      String        @map("recorded_by") @db.Uuid
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt       DateTime?     @map("deleted_at") @db.Timestamptz
  deletedBy       String?       @map("deleted_by") @db.Uuid
  isDeleted       Boolean       @default(false) @map("is_deleted")

  // Relations
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  branch        Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  recorder      User          @relation(fields: [recordedBy], references: [id], onDelete: Restrict)
  deleter       User?         @relation("ConsumptionDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([inventoryItemId])
  @@index([branchId])
  @@index([consumedAt])
  @@index([recordedBy])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("inventory_consumption")
}

// 8. Notifications Table
model Notification {
  id          String               @id @default(uuid()) @db.Uuid
  type        String               @db.VarChar(100)
  title       String               @db.VarChar(255)
  message     String               @db.Text
  relatedId   String?              @map("related_id") @db.Uuid
  relatedType String?              @map("related_type") @db.VarChar(50)
  branchId    String?              @map("branch_id") @db.Uuid
  createdBy   String               @map("created_by") @db.Uuid
  isRead      Boolean              @default(false) @map("is_read")
  readAt      DateTime?            @map("read_at") @db.Timestamptz
  severity    NotificationSeverity @default(INFO)
  createdAt   DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime             @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime?            @map("deleted_at") @db.Timestamptz
  deletedBy   String?              @map("deleted_by") @db.Uuid
  isDeleted   Boolean              @default(false) @map("is_deleted")

  // Relations
  branch  Branch? @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator User    @relation("NotificationCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  deleter User?   @relation("NotificationDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([branchId])
  @@index([createdBy])
  @@index([type])
  @@index([isRead])
  @@index([severity])
  @@index([createdAt])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("notifications")
}

// 9. Notification Settings Table
model NotificationSetting {
  id               String        @id @default(uuid()) @db.Uuid
  userId           String        @map("user_id") @db.Uuid
  notificationType String        @map("notification_type") @db.VarChar(100)
  isEnabled        Boolean       @default(true) @map("is_enabled")
  minAmount        Decimal?      @map("min_amount") @db.Decimal(15, 2)
  selectedBranches Json?         @map("selected_branches") @db.JsonB
  displayMethod    DisplayMethod @default(POPUP) @map("display_method")
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt        DateTime?     @map("deleted_at") @db.Timestamptz
  deletedBy        String?       @map("deleted_by") @db.Uuid
  isDeleted        Boolean       @default(false) @map("is_deleted")

  // Relations
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  deleter User? @relation("NotificationSettingDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@unique([userId, notificationType])
  @@index([userId])
  @@index([notificationType])
  @@index([isEnabled])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("notification_settings")
}

// 10. Audit Log Table (NO soft delete - immutable audit data)
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String   @map("entity_id") @db.Uuid
  changes    Json     @db.JsonB
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_log")
}

// 11. Currency Settings Table
model CurrencySettings {
  id        String    @id @default(uuid()) @db.Uuid
  code      String    @unique @db.VarChar(3)
  nameAr    String    @map("name_ar") @db.VarChar(100)
  nameEn    String    @map("name_en") @db.VarChar(100)
  symbol    String    @db.VarChar(10)
  isDefault Boolean   @default(false) @map("is_default")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz
  deletedBy String?   @map("deleted_by") @db.Uuid
  isDeleted Boolean   @default(false) @map("is_deleted")

  // Relations
  deleter User? @relation("CurrencySettingsDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([isDefault])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("currency_settings")
}

// 12. App Settings Table
model AppSettings {
  id                 String    @id @default(uuid()) @db.Uuid
  loginBackgroundUrl String?   @map("login_background_url") @db.Text
  appName            String?   @map("app_name") @db.VarChar(200)
  appIconUrl         String?   @map("app_icon_url") @db.Text
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt          DateTime? @map("deleted_at") @db.Timestamptz
  deletedBy          String?   @map("deleted_by") @db.Uuid
  isDeleted          Boolean   @default(false) @map("is_deleted")

  // Relations
  deleter User? @relation("AppSettingsDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([isDeleted])
  @@index([deletedAt])
  @@map("app_settings")
}

// 13. Employees Table
model Employee {
  id         String         @id @default(uuid()) @db.Uuid
  branchId   String         @map("branch_id") @db.Uuid
  name       String         @db.VarChar(200)
  status     EmployeeStatus @default(ACTIVE)
  position   String         @db.VarChar(100)
  baseSalary Decimal        @map("base_salary") @db.Decimal(15, 2)
  allowance  Decimal        @default(0) @db.Decimal(15, 2)
  hireDate   DateTime       @map("hire_date") @db.Date
  resignDate DateTime?      @map("resign_date") @db.Date
  createdBy  String         @map("created_by") @db.Uuid
  createdAt  DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime       @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt  DateTime?      @map("deleted_at") @db.Timestamptz
  deletedBy  String?        @map("deleted_by") @db.Uuid
  isDeleted  Boolean        @default(false) @map("is_deleted")

  // Relations
  branch         Branch               @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator        User                 @relation("EmployeeCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  deleter        User?                @relation("EmployeeDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)
  salaryPayments SalaryPayment[]
  transactions   Transaction[]        @relation("EmployeeTransactions")
  adjustments    EmployeeAdjustment[]

  @@index([branchId])
  @@index([status])
  @@index([hireDate])
  @@index([resignDate])
  @@index([deletedAt])
  @@index([isDeleted])
  @@index([createdBy])
  @@index([branchId, status])
  @@map("employees")
}

// NEW: Employee Adjustments Table (Bonuses, Deductions, etc.)
model EmployeeAdjustment {
  id              String                   @id @default(uuid()) @db.Uuid
  employeeId      String                   @map("employee_id") @db.Uuid
  type            EmployeeAdjustmentType
  amount          Decimal                  @db.Decimal(15, 2)
  date            DateTime                 @db.Date
  description     String?                  @db.Text
  status          EmployeeAdjustmentStatus @default(PENDING)
  salaryPaymentId String?                  @map("salary_payment_id") @db.Uuid
  createdBy       String                   @map("created_by") @db.Uuid
  createdAt       DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime                 @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt       DateTime?                @map("deleted_at") @db.Timestamptz
  deletedBy       String?                  @map("deleted_by") @db.Uuid
  isDeleted       Boolean                  @default(false) @map("is_deleted")

  // Relations
  employee      Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  salaryPayment SalaryPayment? @relation(fields: [salaryPaymentId], references: [id], onDelete: SetNull)
  creator       User           @relation("EmployeeAdjustmentCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  deleter       User?          @relation("EmployeeAdjustmentDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([type])
  @@index([status])
  @@index([date])
  @@index([salaryPaymentId])
  @@index([createdBy])
  @@index([deletedAt])
  @@index([isDeleted])
  @@map("employee_adjustments")
}

// 14. Salary Payments Table
model SalaryPayment {
  id            String    @id @default(uuid()) @db.Uuid
  employeeId    String    @map("employee_id") @db.Uuid
  amount        Decimal   @db.Decimal(15, 2)
  paymentDate   DateTime  @map("payment_date") @db.Date
  notes         String?   @db.Text
  transactionId String?   @unique @map("transaction_id") @db.Uuid
  recordedBy    String    @map("recorded_by") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz
  deletedBy     String?   @map("deleted_by") @db.Uuid
  isDeleted     Boolean   @default(false) @map("is_deleted")

  // Relations
  employee    Employee             @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  transaction Transaction?         @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  recorder    User                 @relation("SalaryPaymentRecorder", fields: [recordedBy], references: [id], onDelete: Restrict)
  deleter     User?                @relation("SalaryPaymentDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)
  adjustments EmployeeAdjustment[]

  @@index([employeeId])
  @@index([paymentDate])
  @@index([recordedBy])
  @@index([transactionId])
  @@index([deletedAt])
  @@index([isDeleted])
  @@index([employeeId, paymentDate])
  @@map("salary_payments")
}

// 17. Transaction Inventory Items Table
model TransactionInventoryItem {
  id            String                 @id @default(uuid()) @db.Uuid
  transactionId String                 @map("transaction_id") @db.Uuid
  inventoryItemId String               @map("inventory_item_id") @db.Uuid
  quantity      Decimal                @db.Decimal(12, 3)
  operationType InventoryOperationType @map("operation_type")
  unitPrice     Decimal                @map("unit_price") @db.Decimal(15, 2)
  // Multi-item discount fields
  subtotal      Decimal                @db.Decimal(15, 2)
  discountType  DiscountType?          @map("discount_type")
  discountValue Decimal?               @map("discount_value") @db.Decimal(15, 4)
  total         Decimal                @db.Decimal(15, 2)
  notes         String?                @db.VarChar(500)
  createdAt     DateTime               @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime               @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime?              @map("deleted_at") @db.Timestamptz
  deletedBy     String?                @map("deleted_by") @db.Uuid
  isDeleted     Boolean                @default(false) @map("is_deleted")

  // Relations
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Restrict)
  deleter       User?       @relation("TransactionInventoryItemDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@index([transactionId])
  @@index([inventoryItemId])
  @@index([operationType])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("transaction_inventory_items")
}

// ============================================================================
// SMART REPORTS MODELS
// ============================================================================

// 18. Report Templates Table
model ReportTemplate {
  id          String     @id @default(uuid()) @db.Uuid
  name        String     @db.VarChar(200)
  description String?    @db.Text
  reportType  ReportType
  config      Json       @db.JsonB
  isPublic    Boolean    @default(false) @map("is_public")
  isDefault   Boolean    @default(false) @map("is_default")
  createdById String     @map("created_by_id") @db.Uuid
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime?  @map("deleted_at") @db.Timestamptz
  deletedBy   String?    @map("deleted_by") @db.Uuid
  isDeleted   Boolean    @default(false) @map("is_deleted")

  // Relations
  createdBy  User              @relation("ReportTemplateCreator", fields: [createdById], references: [id], onDelete: Restrict)
  deleter    User?             @relation("ReportTemplateDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)
  executions ReportExecution[]

  @@index([createdById])
  @@index([reportType])
  @@index([isPublic])
  @@index([isDefault])
  @@index([deletedAt])
  @@index([isDeleted])
  @@map("report_templates")
}

// 19. Report Field Metadata Table
model ReportFieldMetadata {
  id             String    @id @default(uuid()) @db.Uuid
  dataSource     String    @db.VarChar(50)
  fieldName      String    @map("field_name") @db.VarChar(100)
  displayName    String    @map("display_name") @db.VarChar(200)
  description    String?   @db.Text
  dataType       String    @map("data_type") @db.VarChar(20)
  filterable     Boolean   @default(true)
  sortable       Boolean   @default(true)
  aggregatable   Boolean   @default(false)
  groupable      Boolean   @default(false)
  defaultVisible Boolean   @default(false) @map("default_visible")
  defaultOrder   Int       @default(999) @map("default_order")
  category       String?   @db.VarChar(100)
  format         String?   @db.VarChar(50)
  enumValues     Json?     @map("enum_values") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz
  deletedBy      String?   @map("deleted_by") @db.Uuid
  isDeleted      Boolean   @default(false) @map("is_deleted")

  // Relations
  deleter User? @relation("ReportFieldMetadataDeleter", fields: [deletedBy], references: [id], onDelete: SetNull)

  @@unique([dataSource, fieldName])
  @@index([dataSource])
  @@index([isDeleted])
  @@index([deletedAt])
  @@map("report_field_metadata")
}

// 20. Report Executions Table (NO soft delete - audit data)
model ReportExecution {
  id             String   @id @default(uuid()) @db.Uuid
  templateId     String?  @map("template_id") @db.Uuid
  config         Json     @db.JsonB
  appliedFilters Json     @map("applied_filters") @db.JsonB
  resultCount    Int      @map("result_count")
  executionTime  Int      @map("execution_time")
  exportFormat   String?  @map("export_format") @db.VarChar(20)
  fileSize       Int?     @map("file_size")
  executedById   String   @map("executed_by_id") @db.Uuid
  executedAt     DateTime @default(now()) @map("executed_at") @db.Timestamptz

  // Relations
  template   ReportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  executedBy User            @relation("ReportExecutor", fields: [executedById], references: [id], onDelete: Restrict)

  @@index([templateId])
  @@index([executedById])
  @@index([executedAt])
  @@map("report_executions")
}
