// Restaurant Accounting System - Prisma Schema
// PostgreSQL Database Schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  ACCOUNTANT

  @@map("user_role")
}

enum TransactionType {
  INCOME
  EXPENSE

  @@map("transaction_type")
}

enum PaymentMethod {
  CASH
  MASTER

  @@map("payment_method")
}

// Currency enum removed - currency is now ONLY in CurrencySettings table
// Database stores amounts without currency, frontend displays currency symbol

enum DebtStatus {
  ACTIVE
  PAID
  PARTIAL

  @@map("debt_status")
}

enum InventoryUnit {
  KG
  PIECE
  LITER
  OTHER

  @@map("inventory_unit")
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL

  @@map("notification_severity")
}

enum DisplayMethod {
  POPUP
  TOAST
  EMAIL
  SMS

  @@map("display_method")
}

enum EmployeeStatus {
  ACTIVE
  RESIGNED

  @@map("employee_status")
}

// ============================================================================
// MODELS
// ============================================================================

// 1. Users Table
model User {
  id                   String    @id @default(uuid()) @db.Uuid
  username             String    @unique @db.VarChar(100)
  passwordHash         String    @map("password_hash") @db.VarChar(255)
  role                 UserRole  @default(ACCOUNTANT)
  branchId             String?   @map("branch_id") @db.Uuid
  isActive             Boolean   @default(true) @map("is_active")
  failedLoginAttempts  Int       @default(0) @map("failed_login_attempts")
  lockedUntil          DateTime? @map("locked_until") @db.Timestamptz
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  branch                   Branch?                  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  refreshTokens            RefreshToken[]
  createdTransactions      Transaction[]            @relation("TransactionCreator")
  createdDebts             Debt[]                   @relation("DebtCreator")
  recordedPayments         DebtPayment[]            @relation("PaymentRecorder")
  recordedConsumptions     InventoryConsumption[]
  createdNotifications     Notification[]           @relation("NotificationCreator")
  notificationSettings     NotificationSetting[]
  auditLogs                AuditLog[]
  createdEmployees         Employee[]               @relation("EmployeeCreator")
  recordedSalaryPayments   SalaryPayment[]          @relation("SalaryPaymentRecorder")
  recordedSalaryIncreases  SalaryIncrease[]         @relation("SalaryIncreaseRecorder")

  @@index([branchId])
  @@index([role])
  @@index([isActive])
  @@index([username])
  @@index([lockedUntil])
  @@map("users")
}

// 2. Refresh Tokens Table
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique @db.VarChar(500)
  userId    String   @map("user_id") @db.Uuid
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// 3. Branches Table
model Branch {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar(200)
  location    String    @db.VarChar(500)
  managerName String    @map("manager_name") @db.VarChar(200)
  phone       String    @db.VarChar(50)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  users                 User[]
  transactions          Transaction[]
  debts                 Debt[]
  inventoryItems        InventoryItem[]
  inventoryConsumptions InventoryConsumption[]
  notifications         Notification[]
  employees             Employee[]

  @@index([isActive])
  @@index([name])
  @@map("branches")
}

// 4. Transactions Table
model Transaction {
  id                 String           @id @default(uuid()) @db.Uuid
  branchId           String           @map("branch_id") @db.Uuid
  type               TransactionType
  amount             Decimal          @db.Decimal(15, 2)
  paymentMethod      PaymentMethod?   @map("payment_method")
  category           String           @db.VarChar(100)
  date               DateTime         @db.Date
  employeeVendorName String           @map("employee_vendor_name") @db.VarChar(200)
  notes              String?          @db.Text
  inventoryItemId    String?          @map("inventory_item_id") @db.Uuid
  createdBy          String           @map("created_by") @db.Uuid
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime         @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt          DateTime?        @map("deleted_at") @db.Timestamptz

  // Relations
  branch         Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator        User            @relation("TransactionCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  inventoryItem  InventoryItem?  @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  salaryPayments SalaryPayment[]

  @@index([branchId])
  @@index([type])
  @@index([date])
  @@index([category])
  @@index([createdBy])
  @@index([paymentMethod])
  @@index([inventoryItemId])
  @@index([deletedAt])
  @@index([branchId, date])
  @@index([type, date])
  @@map("transactions")
}

// 5. Debts Table
model Debt {
  id              String      @id @default(uuid()) @db.Uuid
  branchId        String      @map("branch_id") @db.Uuid
  creditorName    String      @map("creditor_name") @db.VarChar(200)
  originalAmount  Decimal     @map("original_amount") @db.Decimal(15, 2)
  remainingAmount Decimal     @map("remaining_amount") @db.Decimal(15, 2)
  date            DateTime    @db.Date
  dueDate         DateTime?   @map("due_date") @db.Date
  status          DebtStatus  @default(ACTIVE)
  notes           String?     @db.Text
  createdBy       String      @map("created_by") @db.Uuid
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt       DateTime?   @map("deleted_at") @db.Timestamptz

  // Relations
  branch   Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator  User          @relation("DebtCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  payments DebtPayment[]

  @@index([branchId])
  @@index([status])
  @@index([dueDate])
  @@index([createdBy])
  @@index([date])
  @@index([deletedAt])
  @@index([status, dueDate])
  @@map("debts")
}

// 6. Debt Payments Table
model DebtPayment {
  id          String   @id @default(uuid()) @db.Uuid
  debtId      String   @map("debt_id") @db.Uuid
  amountPaid  Decimal  @map("amount_paid") @db.Decimal(15, 2)
  paymentDate DateTime @map("payment_date") @db.Date
  notes       String?  @db.Text
  recordedBy  String   @map("recorded_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  debt     Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)
  recorder User @relation("PaymentRecorder", fields: [recordedBy], references: [id], onDelete: Restrict)

  @@index([debtId])
  @@index([paymentDate])
  @@index([recordedBy])
  @@map("debt_payments")
}

// 7. Inventory Items Table
model InventoryItem {
  id           String        @id @default(uuid()) @db.Uuid
  branchId     String        @map("branch_id") @db.Uuid
  name         String        @db.VarChar(200)
  quantity     Decimal       @db.Decimal(12, 3)
  unit         InventoryUnit
  costPerUnit  Decimal       @map("cost_per_unit") @db.Decimal(15, 2)
  lastUpdated  DateTime      @map("last_updated") @db.Timestamptz
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime      @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime?     @map("deleted_at") @db.Timestamptz

  // Relations
  branch       Branch                 @relation(fields: [branchId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  consumptions InventoryConsumption[]

  @@index([branchId])
  @@index([name])
  @@index([unit])
  @@index([lastUpdated])
  @@index([deletedAt])
  @@map("inventory_items")
}

// 7b. Inventory Consumption Table
model InventoryConsumption {
  id              String        @id @default(uuid()) @db.Uuid
  inventoryItemId String        @map("inventory_item_id") @db.Uuid
  branchId        String        @map("branch_id") @db.Uuid
  quantity        Decimal       @db.Decimal(12, 3)
  unit            InventoryUnit
  reason          String?       @db.VarChar(500)
  consumedAt      DateTime      @map("consumed_at") @db.Timestamptz
  recordedBy      String        @map("recorded_by") @db.Uuid
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  branch        Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  recorder      User          @relation(fields: [recordedBy], references: [id], onDelete: Restrict)

  @@index([inventoryItemId])
  @@index([branchId])
  @@index([consumedAt])
  @@index([recordedBy])
  @@map("inventory_consumption")
}

// 8. Notifications Table
model Notification {
  id          String                 @id @default(uuid()) @db.Uuid
  type        String                 @db.VarChar(100)
  title       String                 @db.VarChar(255)
  message     String                 @db.Text
  relatedId   String?                @map("related_id") @db.Uuid
  relatedType String?                @map("related_type") @db.VarChar(50)
  branchId    String?                @map("branch_id") @db.Uuid
  createdBy   String                 @map("created_by") @db.Uuid
  isRead      Boolean                @default(false) @map("is_read")
  readAt      DateTime?              @map("read_at") @db.Timestamptz
  severity    NotificationSeverity   @default(INFO)
  createdAt   DateTime               @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime               @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  branch  Branch? @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator User    @relation("NotificationCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([branchId])
  @@index([createdBy])
  @@index([type])
  @@index([isRead])
  @@index([severity])
  @@index([createdAt])
  @@map("notifications")
}

// 9. Notification Settings Table
model NotificationSetting {
  id                String          @id @default(uuid()) @db.Uuid
  userId            String          @map("user_id") @db.Uuid
  notificationType  String          @map("notification_type") @db.VarChar(100)
  isEnabled         Boolean         @default(true) @map("is_enabled")
  minAmount         Decimal?        @map("min_amount") @db.Decimal(15, 2)
  selectedBranches  Json?           @map("selected_branches") @db.JsonB
  displayMethod     DisplayMethod   @map("display_method") @default(POPUP)
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime        @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@index([userId])
  @@index([notificationType])
  @@index([isEnabled])
  @@map("notification_settings")
}

// 10. Audit Log Table
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String   @map("entity_id") @db.Uuid
  changes    Json     @db.JsonB
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_log")
}

// 11. Currency Settings Table
model CurrencySettings {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique @db.VarChar(3)
  nameAr    String   @map("name_ar") @db.VarChar(100)
  nameEn    String   @map("name_en") @db.VarChar(100)
  symbol    String   @db.VarChar(10)
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([isDefault])
  @@map("currency_settings")
}

// 12. Employees Table
model Employee {
  id             String         @id @default(uuid()) @db.Uuid
  branchId       String         @map("branch_id") @db.Uuid
  name           String         @db.VarChar(200)
  status         EmployeeStatus @default(ACTIVE)
  position       String         @db.VarChar(100)
  baseSalary     Decimal        @map("base_salary") @db.Decimal(15, 2)
  allowance      Decimal        @default(0) @db.Decimal(15, 2)
  hireDate       DateTime       @map("hire_date") @db.Date
  resignDate     DateTime?      @map("resign_date") @db.Date
  createdBy      String         @map("created_by") @db.Uuid
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt      DateTime?      @map("deleted_at") @db.Timestamptz

  // Relations
  branch          Branch           @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator         User             @relation("EmployeeCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  salaryPayments  SalaryPayment[]
  salaryIncreases SalaryIncrease[]

  @@index([branchId])
  @@index([status])
  @@index([hireDate])
  @@index([resignDate])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([branchId, status])
  @@map("employees")
}

// 13. Salary Payments Table
model SalaryPayment {
  id            String    @id @default(uuid()) @db.Uuid
  employeeId    String    @map("employee_id") @db.Uuid
  amount        Decimal   @db.Decimal(15, 2)
  paymentDate   DateTime  @map("payment_date") @db.Date
  notes         String?   @db.Text
  transactionId String?   @unique @map("transaction_id") @db.Uuid
  recordedBy    String    @map("recorded_by") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  employee    Employee     @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  transaction Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  recorder    User         @relation("SalaryPaymentRecorder", fields: [recordedBy], references: [id], onDelete: Restrict)

  @@index([employeeId])
  @@index([paymentDate])
  @@index([recordedBy])
  @@index([transactionId])
  @@index([deletedAt])
  @@index([employeeId, paymentDate])
  @@map("salary_payments")
}

// 14. Salary Increases Table
model SalaryIncrease {
  id             String   @id @default(uuid()) @db.Uuid
  employeeId     String   @map("employee_id") @db.Uuid
  oldSalary      Decimal  @map("old_salary") @db.Decimal(15, 2)
  newSalary      Decimal  @map("new_salary") @db.Decimal(15, 2)
  increaseAmount Decimal  @map("increase_amount") @db.Decimal(15, 2)
  effectiveDate  DateTime @map("effective_date") @db.Date
  reason         String?  @db.Text
  recordedBy     String   @map("recorded_by") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  recorder User     @relation("SalaryIncreaseRecorder", fields: [recordedBy], references: [id], onDelete: Restrict)

  @@index([employeeId])
  @@index([effectiveDate])
  @@index([recordedBy])
  @@index([employeeId, effectiveDate])
  @@map("salary_increases")
}
