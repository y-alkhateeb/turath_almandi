// Restaurant Accounting System - Prisma Schema
// PostgreSQL Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  ACCOUNTANT

  @@map("user_role")
}

enum TransactionType {
  INCOME
  EXPENSE

  @@map("transaction_type")
}

enum PaymentMethod {
  CASH
  MASTER

  @@map("payment_method")
}

enum Currency {
  USD
  EUR
  IQD
  SAR
  AED

  @@map("currency")
}

enum DebtStatus {
  ACTIVE
  PAID
  PARTIAL

  @@map("debt_status")
}

enum InventoryUnit {
  KG
  PIECE
  LITER
  OTHER

  @@map("inventory_unit")
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL

  @@map("notification_severity")
}

enum DisplayMethod {
  POPUP
  TOAST
  EMAIL
  SMS

  @@map("display_method")
}

// ============================================================================
// MODELS
// ============================================================================

// 1. Users Table
model User {
  id            String    @id @default(uuid()) @db.Uuid
  username      String    @unique @db.VarChar(100)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  role          UserRole  @default(ACCOUNTANT)
  branchId      String?   @map("branch_id") @db.Uuid
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  branch                Branch?               @relation(fields: [branchId], references: [id], onDelete: SetNull)
  createdTransactions   Transaction[]         @relation("TransactionCreator")
  createdDebts          Debt[]                @relation("DebtCreator")
  recordedPayments      DebtPayment[]         @relation("PaymentRecorder")
  createdNotifications  Notification[]        @relation("NotificationCreator")
  notificationSettings  NotificationSetting[]
  auditLogs             AuditLog[]

  @@index([branchId])
  @@index([role])
  @@index([isActive])
  @@index([username])
  @@map("users")
}

// 2. Branches Table
model Branch {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar(200)
  location    String    @db.VarChar(500)
  managerName String    @map("manager_name") @db.VarChar(200)
  phone       String    @db.VarChar(50)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  users            User[]
  transactions     Transaction[]
  debts            Debt[]
  inventoryItems   InventoryItem[]
  notifications    Notification[]

  @@index([isActive])
  @@index([name])
  @@map("branches")
}

// 3. Transactions Table
model Transaction {
  id                 String           @id @default(uuid()) @db.Uuid
  branchId           String           @map("branch_id") @db.Uuid
  type               TransactionType
  amount             Decimal          @db.Decimal(15, 2)
  currency           Currency         @default(USD)
  paymentMethod      PaymentMethod?   @map("payment_method")
  category           String           @db.VarChar(100)
  date               DateTime         @db.Date
  employeeVendorName String           @map("employee_vendor_name") @db.VarChar(200)
  notes              String?          @db.Text
  createdBy          String           @map("created_by") @db.Uuid
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  branch  Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator User   @relation("TransactionCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([branchId])
  @@index([type])
  @@index([date])
  @@index([category])
  @@index([createdBy])
  @@index([paymentMethod])
  @@index([currency])
  @@map("transactions")
}

// 4. Debts Table
model Debt {
  id              String      @id @default(uuid()) @db.Uuid
  branchId        String      @map("branch_id") @db.Uuid
  creditorName    String      @map("creditor_name") @db.VarChar(200)
  originalAmount  Decimal     @map("original_amount") @db.Decimal(15, 2)
  remainingAmount Decimal     @map("remaining_amount") @db.Decimal(15, 2)
  date            DateTime    @db.Date
  dueDate         DateTime?   @map("due_date") @db.Date
  status          DebtStatus  @default(ACTIVE)
  notes           String?     @db.Text
  createdBy       String      @map("created_by") @db.Uuid
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  branch   Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator  User          @relation("DebtCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  payments DebtPayment[]

  @@index([branchId])
  @@index([status])
  @@index([dueDate])
  @@index([createdBy])
  @@index([date])
  @@map("debts")
}

// 5. Debt Payments Table
model DebtPayment {
  id          String   @id @default(uuid()) @db.Uuid
  debtId      String   @map("debt_id") @db.Uuid
  amountPaid  Decimal  @map("amount_paid") @db.Decimal(15, 2)
  paymentDate DateTime @map("payment_date") @db.Date
  notes       String?  @db.Text
  recordedBy  String   @map("recorded_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  debt     Debt @relation(fields: [debtId], references: [id], onDelete: Cascade)
  recorder User @relation("PaymentRecorder", fields: [recordedBy], references: [id], onDelete: Restrict)

  @@index([debtId])
  @@index([paymentDate])
  @@index([recordedBy])
  @@map("debt_payments")
}

// 6. Inventory Items Table
model InventoryItem {
  id           String        @id @default(uuid()) @db.Uuid
  branchId     String        @map("branch_id") @db.Uuid
  name         String        @db.VarChar(200)
  quantity     Decimal       @db.Decimal(12, 3)
  unit         InventoryUnit
  costPerUnit  Decimal       @map("cost_per_unit") @db.Decimal(12, 2)
  lastUpdated  DateTime      @map("last_updated") @db.Timestamptz
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
  @@index([name])
  @@index([unit])
  @@index([lastUpdated])
  @@map("inventory_items")
}

// 7. Notifications Table
model Notification {
  id          String                 @id @default(uuid()) @db.Uuid
  type        String                 @db.VarChar(100)
  title       String                 @db.VarChar(255)
  message     String                 @db.Text
  relatedId   String?                @map("related_id") @db.Uuid
  relatedType String?                @map("related_type") @db.VarChar(50)
  branchId    String?                @map("branch_id") @db.Uuid
  createdBy   String                 @map("created_by") @db.Uuid
  isRead      Boolean                @default(false) @map("is_read")
  readAt      DateTime?              @map("read_at") @db.Timestamptz
  severity    NotificationSeverity   @default(INFO)
  createdAt   DateTime               @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  branch  Branch? @relation(fields: [branchId], references: [id], onDelete: Cascade)
  creator User    @relation("NotificationCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([branchId])
  @@index([createdBy])
  @@index([type])
  @@index([isRead])
  @@index([severity])
  @@index([createdAt])
  @@map("notifications")
}

// 8. Notification Settings Table
model NotificationSetting {
  id                String          @id @default(uuid()) @db.Uuid
  userId            String          @map("user_id") @db.Uuid
  notificationType  String          @map("notification_type") @db.VarChar(100)
  isEnabled         Boolean         @default(true) @map("is_enabled")
  minAmount         Decimal?        @map("min_amount") @db.Decimal(15, 2)
  selectedBranches  Json?           @map("selected_branches") @db.JsonB
  displayMethod     DisplayMethod   @map("display_method") @default(POPUP)
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime        @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@index([userId])
  @@index([notificationType])
  @@index([isEnabled])
  @@map("notification_settings")
}

// 9. Audit Log Table
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String   @db.VarChar(100)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String   @map("entity_id") @db.Uuid
  changes    Json     @db.JsonB
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_log")
}
